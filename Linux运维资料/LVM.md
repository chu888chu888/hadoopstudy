##LVM简介及常用命令

一、LVM介绍
LVM是 Logical Volume Manager(逻辑卷管理)的简写，它是Linux环境下对磁盘分区进行管理的一种机制

LVM - 优点:
LVM通常用于装备大量磁盘的系统，但它同样适于仅有一、两块硬盘的小系统。

小系统使用LVM的益处:

传统的文件系统是基于分区的，一个文件系统对应一个分区。这种方式比较直观，但不易改变：

1.不同的分区相对独立，无相互联系，各分区空间很易利用不平衡，空间不能充分利用；

2.当一个文件系统／分区已满时，无法对其扩充，只能采用重新分区／建立文件系统，非常麻烦；或把分区中的数据移到另一个更大的分区中；或采用符号连接的方式使用其它分区的空间。

3.如果要把硬盘上的多个分区合并在一起使用，只能采用再分区的方式，这个过程需要数据的备份与恢复。

当采用LVM时，情况有所不同：

1.硬盘的多个分区由LVM统一为卷组管理，可以方便的加入或移走分区以扩大或减小卷组的可用容量，充分利用硬盘空间；

2.文件系统建立在逻辑卷上，而逻辑卷可根据需要改变大小(在卷组容量范围内)以满足要求；

3.文件系统建立在LVM上，可以跨分区，方便使用；

大系统使用LVM的益处:

1、在使用很多硬盘的大系统中，使用LVM主要是方便管理、增加了系统的扩展性。

2、在一个有很多不同容量硬盘的大型系统中，对不同的用户的空间分配是一个技巧性的工作，要在用户需求与实际可用空间中寻求平衡。

3、用户／用户组的空间建立在LVM上，可以随时按要求增大，或根据使用情况对各逻辑卷进行调整。当系统空间不足而加入新的硬盘时，不必把用户的数据从原硬盘迁移到新硬盘，而只须把新的分区加入卷组并扩充逻辑卷即可。同样，使用LVM可以在不停服务的情况下。把用户数据从旧硬盘转移到新硬盘空间中去。

二、 基本概念
1、 物理卷-----PV（Physical Volume）
 物理卷在逻辑卷管理中处于最底层，它可以是实际物理硬盘上的分区，也可以是整个物理硬盘。

2、 卷组--------VG（Volumne Group）
 卷组建立在物理卷之上，一个卷组中至少要包括一个物理卷，在卷组建立之后可动态添加物理卷到卷组中。一个逻辑卷管理系统工程中可以只有一个卷组，也可以拥有多个卷组。

3、 逻辑卷-----LV（Logical Volume）
 逻辑卷建立在卷组之上，卷组中的未分配空间可以用于建立新的逻辑卷，逻辑卷建立后可以动态地扩展和缩小空间。系统中的多个逻辑卷要以属于同一个卷组，也可以属于不同的多个卷组。

4、 物理区域--PE（Physical Extent）
 物理区域是物理卷中可用于分配的最小存储单元，物理区域的大小可根据实际情况在建立物理卷时指定。物理区域大小一旦确定将不能更改，同一卷组中的所有物理卷的物理区域大小需要一致。

5、 逻辑区域―LE（Logical Extent）
 逻辑区域是逻辑卷中可用于分配的最小存储单元，逻辑区域的大小取决于逻辑卷所在卷组中的物理区域的大小。

6、 卷组描述区域-----（Volume Group Descriptor Area）
 卷组描述区域存在于每个物理卷中，用于描述物理卷本身、物理卷所属卷组、卷组中的逻辑卷及逻辑卷中物理区域的分配等所有信息，卷组描述区域是在使用pvcreate建立物理卷时建立的。

三、 常用命令
1、 物理卷命令
一般维护命令：
pvscan #在系统的所有磁盘中搜索已存在的物理卷
pvdisplay 物理卷全路径名称 #用于显示指定物理卷的属性。
pvdata 物理卷全路径名称 #用于显示物理卷的卷组描述区域信息，用于调试目的。
pvchange Cx|--allocation {y|n} 物理卷全路径名 #用于改变物理卷的分配许可设置物理卷的创建与删除命令
pvcreate 设备全路径名 #用于在磁盘或磁盘分区上创建物理卷初始化信息，以便对该物理卷进行逻辑卷管理。
pvmove 源物理卷全路径我[目的物理卷全路径名] #用于把某物理卷中的数据转移到同卷组中其他的特刊卷中。

2、 卷组命令
一般维护命令
vgscan #检测系统中所有磁盘
vgck [卷组名] #用于检查卷组中卷组描述区域信息的一致性。
vgdisplay [卷组名] #显示卷组的属性信息
vgrename 原卷组名 新卷组名
vgchange -a y|n [卷组名] #改变卷组的相应属性。是否可分配
vgchange -l 最大逻辑卷数 #卷组可容纳最大逻辑卷数
vgchange -x y|n [卷组名] #卷是否有效
vgmknodes [卷组名|卷组路径] #用于建立（重新建立）已有卷组目录和其中的设备文件卷组配置的备份与恢复命令
vgcfgbackup [卷组名] #把卷组中的VGDA信息备份到“/etc/lvmconf”目录中的文件
vgcfgrestore -n 卷组名 物理卷全路命名 #从备份文件中必得指定物理卷的信息卷组的建立与删除命令
vgcreate 卷组名 物理卷全路径名[物理卷全路径名]
vgmove 卷组名

卷组的扩充与缩小命令
vgextend 卷组名 物理卷全路径名[物理卷全路径名]
vgreduce 卷组名 物理卷全路径名[物理卷全路径名]

卷组的合并与拆分
vgmerge 目的卷组名 源卷组名 #合并两个已经存在的卷组，要求两个卷组的物理区域大小相等且源卷组是非活动的。
vgsplit 现有卷组 新卷组 物理卷全路径名[物理卷全路径名]

卷组的输入与输出命令
vgexport 卷组名
vgimport 卷组名 卷组中的物理卷[卷组中的物理卷]

3、 逻辑卷命令
 一般命令
lvscan
lvdisplay 逻辑卷全路径名[逻辑卷全路径名]
lvrename 旧逻辑卷全路径名 新逻辑卷全路径名
lvrename 卷组名 旧逻辑卷名 新逻辑卷名
lvchange
e2fsadm -L +|- 逻辑卷增减量 逻辑卷全路径名

逻辑卷的创建与删除命令
lvcreate
lvremove

逻辑卷的扩充与缩小命令
lvextend -L|--size +逻辑卷大小增量 逻辑卷全路径名
lvreduce q -L|--size +逻辑卷减小量 逻辑卷全路径名

4、 逻辑卷管理命令
lvmdiskscan #检测所有的SCSI、IDE等存储设备
lvmchange -R|--reset #复位逻辑卷管理器
lvmsadc [日志文件全路径名] #收信逻辑卷管理器读写统计信息，保存到日志文件中。
lvmsar 日志文件全路径名 #从lvmsadc命令生成的日志文件中读取并报告逻辑卷管理器的读写统计信息。

##在ESXi中做磁盘扩容（LVM）


一、准备

1、SSH登录ESXi（见第一章）

2、更改虚拟磁盘大小，特别需要注意的是，如果此虚拟机已有快照，请删除所有快照再执行以下操作，否则这个VMDK将出错，内部的资料丢失！

3、关闭虚拟机，进入需要增加硬盘的虚拟机的vmdk目录下（这里为centos7）
	
	cd /vmfs/volumes/datastore1/centos7

4、执行命令（这里为名字是centos7这台虚拟机增加500G硬盘容量），更详细参考这里 
[http://dngood.blog.51cto.com/446195/785770  ](http://dngood.blog.51cto.com/446195/785770  )

	vmkfstools -X [新的大小] [目标vmdk文件]
	例：vmkfstools -X 400g centos7.vmdk

5、打开虚拟机，进入后输入fdisk -l即可查看到刚刚添加的sdb
	

6、查看分区挂载情况，这里为home目录增加100G大小

二、挂载

1、创建物理卷（PV）

	pvcreate /dev/sdb

2、查看系统PV情况

	pvdisplay

3、查看原VG情况
	
	vgdisplay

4、扩展卷组，将/dev/sdb物理卷添加到centos卷组中(执行完后可以查看VG大小的变化)

	vgextend centos /dev/sdb


5、以上只是卷扩容了，下面是文件系统的真正扩容(这里对home目录扩容)，执行命令

	#CentOS7使用的是XFS，执行：
	xfs_growfs /home

	#CentOS6执行：
	resize2fs /home
	
6、查看新的磁盘空间

	df -h


##在VMware中做磁盘扩容（LVM）

一、步骤

1、查看挂载点信息：
	
	df -h

2、扩展VMware硬盘空间

	关闭VMware的Linux系统，这样才能在VMware菜单中设置需要增加到的磁盘大小

3、对新增加的硬盘进行分区（新增加的硬盘是/dev/sdb）
		
	fdisk /dev/sdb

可以用m命令来看fdisk命令的内部命令；

- n命令创建一个新分区，其中p为主分区，e为扩展分区；

- d命令删除一个存在的分区；

- p命令显示分区列表；

- t命令修改分区的类型ID号；

- l命令显示分区ID号的列表；

- a命令指定启动分区；

- w命令是将对分区表的修改存盘让它发生作用

这里是创建分区，所以输入n，然后输入p，接下来输入块数按照原来硬盘递归的大小进行填写，最后输入w保存。

4、对新增的硬盘进行格式化
	
	mkfs.ext4 /dev/sdb

5、添加新LVM到已有的LVM组，实现扩容

	lvm                  				#进入lvm管理
	lvm>pvcreate /dev/sdb				#创建物理卷pv	
	lvm>vgdisplay						#查看VG name
	lvm>vgextend centos /dev/sdb2		#将初始化过的分区加入到虚拟卷组VG name中
	lvm>lvextend -l+21513 /home			#扩展home目录（21513是通过vgdisplay查看的free的大小）
	lvm>pvdisplay						#查看卷容量
	lvm>quit							#退出

6、以上只是卷扩容操作，还需要对文件系统进行扩容，执行命令

	#CentOS7使用的是XFS，执行：
	xfs_growfs /home

	#CentOS6执行：
	resize2fs /home
	
7、查看新的磁盘空间

	df -h
	





	
	
	


	


